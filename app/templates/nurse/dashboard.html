<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurse Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nurse.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js", defer></script>
</head>
<body>
<div class="d-flex" id="wrapper">

    <!-- Sidebar -->
    <div class="border-end bg-light" id="sidebar-wrapper">
        <div class="sidebar-heading text-center py-4">
            <h5>Hospital Name</h5>
        </div>
        <div class="list-group list-group-flush">
            <a href="{{ url_for('patients.list_patients') }}" class="list-group-item list-group-item-action bg-light">Patients</a>
            <a href="{{ url_for('lab.lab_results') }}" class="list-group-item list-group-item-action bg-light">Lab Results</a>

            <a href="{{ url_for('nurse.inbox') }}" class="list-group-item list-group-item-action bg-light">
            Messages 
            {% if unread_count > 0 %}
            <span class="badge">{{ unread_count }}</span>
            {% endif %}
            </a>
            <span id="msgCount" class="badge">{{ unread_count }}</span>
            <a href="{{ url_for('auth.logout') }}" class="list-group-item list-group-item-action bg-light text-danger">Logout</a>
        </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page content -->
    <div id="page-content-wrapper" class="w-100">

        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
            <div class="container-fluid">
                <form class="d-flex ms-auto" action="{{ url_for('nurse.search') }}" method="GET">
                    <input class="form-control me-2" type="search" name="q" placeholder="Search Patients" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
                <div class="ms-3">
                    <span class="fw-bold">{{ current_user.first_name }} {{ current_user.surname }}</span>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="container-fluid mt-4">

            <!-- Quick Metrics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Upcoming Medications</h5>
                            <p class="card-text fs-4">{{upcoming_meds }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning mb-3">
                        <div class="card-body">
                        <h5 class="card-title">ðŸ’Š Pending Medications</h5>
                        <p class="card-text fs-4 fw-bold 
                            {% if pending_medications_count > 0 %} text-danger {% else %} text-success {% endif %}">
                            {{ pending_medications_count }}
                        </p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card text-white bg-success mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Pending Lab Results</h5>
                            <p class="card-text fs-4">{{ pending_lab }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Time</h5>
                            <p class="card-text fs-4">{{ current_time.strftime("%I:%M %p") }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient List Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Patient List</h5>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-hover table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Hospital Number</th>
                                <th>Age</th>
                                <th>Sex</th>
                                <th>Room/Ward</th>
                                <th>Last Visit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                       <tbody>
                        {% for patient in patients %}
                        <tr id="patient-row-{{ patient.id }}">
                            <td>{{ patient.full_name() }}</td>
                            <td>{{ patient.hospital_number }}</td>
                            <td>{{ patient.calculate_age() }}</td>
                            <td>{{ patient.sex.value }}</td>
                            <td>{{ patient.ward or '-' }}</td>
                            <td>{{ patient.created_at.strftime("%Y-%m-%d") }}</td>
                            <td>
                                <a href="{{ url_for('patients.patient_summary', patient_id=patient.id) }}" class="btn btn-sm btn-primary">View Card</a>
                                <button class="btn btn-sm btn-success done-btn" data-id="{{ patient.id }}">Done</button>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div> <!-- /container-fluid -->

    </div> <!-- /page-content-wrapper -->

</div> <!-- /wrapper -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const sidebarToggle = document.getElementById('sidebarToggle');
    const wrapper = document.getElementById('wrapper');
    sidebarToggle.addEventListener('click', () => {
        wrapper.classList.toggle('toggled');
    });
</script>



<script>
document.addEventListener("DOMContentLoaded", function() {
    const buttons = document.querySelectorAll(".done-btn");

    buttons.forEach(button => {
        button.addEventListener("click", function() {
            const patientId = this.getAttribute("data-id");

            fetch(`/nurse/mark_done/${patientId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Requested-With": "XMLHttpRequest"
                },
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // remove the row instantly
                    const row = document.getElementById(`patient-row-${patientId}`);
                    row.remove();
                } else {
                    alert("Failed to mark patient as done.");
                }
            })
            .catch(err => console.error(err));
        });
    });
});


//message notification//
setInterval(() => {
    fetch("{{ url_for('doctor.check_messages') }}")
        .then(r => r.json())
        .then(data => {
            document.getElementById("msgCount").innerText = data.unread;
        });
}, 5000);


</script>
</body>
</html>

