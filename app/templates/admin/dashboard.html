{% extends "base.html" %}
{% block content %}

<h1>üè• Admin Dashboard</h1>
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('admin.view_requests') }}">
        üìù Requests
        {% if unread_requests_count > 0 %}
        <span class="badge bg-danger">{{ unread_requests_count }}</span>
        {% endif %}
    </a>
    <form action="{{ url_for('admin.clear_request_notifications') }}" method="POST" style="display:inline;">
    <button class="btn btn-sm btn-warning">Clear Notifications</button>
    </form>
</li>

<!-- Quick Stats -->
<div class="stats-cards">
  <div class="card">
    <h3>{{ employees|length }}</h3>
    <p>Total Employees</p>
  </div>
  <div class="card">
    <h3>{{ active_count }}</h3>
    <p>Active Employees</p>
  </div>
  <div class="card">
    <h3>{{ inactive_count }}</h3>
    <p>Inactive Employees</p>
  </div>
  <div class="card">
    <h3>{{ roles|length }}</h3>
    <p>Roles</p>
  </div>
</div>
<hr>

<!-- Role Distribution -->
<h2>üìä Role Distribution</h2>
<canvas id="roleChart" width="400" height="200"></canvas>

<hr>


<!-- Monthly Shift Roster -->
<h2>üìã Shift Roster ‚Äî {{ month_name }} {{ year }}</h2>
<div class="shift-roster">
  {% for shift_name, emp_list in shift_roster.items() %}
    <div class="shift-card">
      <h4>{{ shift_name }} Shift ({{ emp_list|length }})</h4>
      <ul>
        {% for emp in emp_list %}
          <li>{{ emp.full_name() if emp else "Unknown" }}</li>
        {% else %}
          <li>No employees assigned</li>
        {% endfor %}
      </ul>
    </div>
  {% else %}
    <p>No shifts assigned for today.</p>
  {% endfor %}
</div>
</div>

<!-- Assign Shift Button -->
<div style="margin-top: 20px;">
    <a href="{{ url_for('admin.assign_shift') }}" class="btn btn-primary">Assign Shifts</a>
</div>



<hr>

<!-- Employee Table -->
<h2>üë• Employee Management</h2>
<a href="{{ url_for('admin.add_employee') }}" class="btn btn-primary">‚ûï Add Employee</a>
<div class="table-responsive">
  <table class="styled-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Department</th>
        <th>Shift</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for emp in employees %}
      <tr>
        <td>{{ emp.full_name() }}</td>
        <td>{{ emp.email }}</td>
        <td>{{ emp.role.name }}</td>
        <td>{{ emp.department or '‚Äî' }}</td>
        <td>{{ emp.shift.value }}</td>
        <td>{{ "Active" if emp.is_active else "Inactive" }}</td>
        <td>
          <a href="{{ url_for('admin.edit_employee', employee_id=emp.id) }}" class="btn btn-sm btn-secondary">Edit</a>
          <form action="{{ url_for('admin.delete_employee', employee_id=emp.id) }}" method="POST" style="display:inline;">
          <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this employee?');">
              Delete
          </button>
            </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('roleChart').getContext('2d');
const roleData = {
  labels: [{% for role, count in role_distribution %}'{{ role }}',{% endfor %}],
  datasets: [{
    label: 'Number of Employees',
    data: [{% for role, count in role_distribution %}{{ count }},{% endfor %}],
    backgroundColor: [
      '#2563eb','#1d4ed8','#10b981','#f59e0b','#ef4444','#8b5cf6'
    ],
    borderWidth: 1
  }]
};

new Chart(ctx, {
  type: 'bar',
  data: roleData,
  options: {
    responsive: true,
    plugins: {
      legend: { display: false },
      title: { display: true, text: 'Employees per Role' }
    },
    scales: { y: { beginAtZero: true } }
  }
});
</script>

<style>
.stats-cards { display: flex; gap: 20px; margin-bottom: 30px; }
.card { background: #2563eb; color: #fff; padding: 20px; border-radius: 12px; flex: 1; text-align: center; }
.shift-roster { display: flex; gap: 20px; margin-bottom: 30px; }
.shift-card { flex: 1; background: #f3f4f6; padding: 15px; border-radius: 12px; }
.styled-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
.styled-table th, .styled-table td { padding: 12px 15px; border: 1px solid #ccc; text-align: left; }
.styled-table th { background: #f9fafb; }
.btn { padding: 8px 12px; border-radius: 6px; text-decoration: none; display: inline-block; margin-right: 5px; }
.btn-primary { background: #2563eb; color: #fff; }
.btn-secondary { background: #6b7280; color: #fff; }
.btn-danger { background: #dc2626; color: #fff; }
</style>
{% endblock %}
