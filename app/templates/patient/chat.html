{% extends "layouts/patient_base.html" %}
{% block content %}
<div class="container mt-4">

    <h3 class="mb-3">
        ðŸ’¬ Chat with Dr. {{ doctor.full_name() }}
        <a href="{{ url_for('patient_chat.inbox') }}" class="btn btn-secondary float-end">Back to Inbox</a>
    </h3>

    <!-- Chat Box -->
    <div id="chat-box" 
         class="border rounded p-3 mb-3" 
         style="height: 450px; overflow-y: scroll; background: #f8f9fa;">
        
        <!-- Messages loaded via AJAX -->
    </div>

    <!-- Send Message Form -->
    <form id="sendMessageForm">
        <div class="input-group">
            <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." required>
            <button class="btn btn-primary">Send</button>
        </div>
    </form>

</div>

<script>
// Load messages
function loadMessages() {
    fetch("{{ url_for('patient_chat.get_messages', doctor_id=doctor.id) }}")
        .then(response => response.json())
        .then(data => {
            let chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = "";

            data.messages.forEach(msg => {
                let bubble = `
                    <div class="mb-2">
                        <div class="p-2 rounded 
                            ${msg.sender === 'patient' ? 'bg-primary text-white ms-auto' : 'bg-light'}"
                             style="max-width: 70%;">
                            ${msg.content}
                            <br>
                            <small class="text-muted">${msg.timestamp}</small>
                        </div>
                    </div>
                `;
                chatBox.innerHTML += bubble;
            });

            chatBox.scrollTop = chatBox.scrollHeight;
        });
}

// Auto-refresh every 2 seconds
setInterval(loadMessages, 2000);
loadMessages();

// Send message
document.getElementById("sendMessageForm").addEventListener("submit", function(e) {
    e.preventDefault();

    let message = document.getElementById("messageInput").value;

    fetch("{{ url_for('patient_chat.send_message', doctor_id=doctor.id) }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById("messageInput").value = "";
        loadMessages();
    });
});
</script>
{% endblock %}
