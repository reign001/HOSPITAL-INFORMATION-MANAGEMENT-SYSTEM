<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor Dashboard | EMR System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --sidebar-width: 260px;
      --primary: #0d6efd;
      --success: #198754;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #0dcaf0;
    }
    body {
      background: #f5f7fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: #1a3a6b;
      color: white;
      padding: 1.5rem;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0 0 .5rem;
    }
    .sidebar-header p {
      margin: 0;
      opacity: 0.8;
      font-size: .9rem;
    }
    .sidebar-nav a {
      display: flex;
      align-items: center;
      gap: .75rem;
      padding: .75rem 1rem;
      color: rgba(255,255,255,.8);
      text-decoration: none;
      border-radius: .5rem;
      margin-bottom: .5rem;
      transition: all .2s;
    }
    .sidebar-nav a:hover, .sidebar-nav a.active {
      background: rgba(255,255,255,.1);
      color: white;
    }
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 2rem;
      min-height: 100vh;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .profile {
      display: flex;
      align-items: center;
      gap: .5rem;
      font-weight: 500;
    }
    .profile::before {
      content: "";
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 50%;
      display: inline-block;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: .75rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .stat-card i {
      font-size: 1.8rem;
      color: var(--primary);
    }
    .stat-card h3 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 600;
    }
    .stat-card p {
      margin: 0;
      color: #6c757d;
      font-size: .9rem;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    .card {
      background: white;
      border-radius: .75rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .card h2 {
      background: #f8f9fa;
      margin: 0;
      padding: 1rem 1.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .card h2 i {
      color: var(--primary);
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .9rem;
    }
    .data-table th {
      background: #f1f3f5;
      text-align: left;
      padding: .75rem 1rem;
      font-weight: 600;
      color: #495057;
    }
    .data-table td {
      padding: .75rem 1rem;
      border-bottom: 1px solid #eee;
    }
    .status {
      padding: .25rem .5rem;
      border-radius: .375rem;
      font-size: .75rem;
      font-weight: 500;
    }
    .status.waiting {
      background: #fff3cd;
      color: #856404;
    }
    .btn.small {
      padding: .25rem .5rem;
      font-size: .8rem;
      border-radius: .375rem;
    }
    .btn.done {
      background: var(--success);
      color: white;
    }
    .btn.done:hover {
      background: #1e7e34;
    }
    .encounter-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .encounter-list li {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #eee;
      font-size: .9rem;
    }
    .encounter-list li small {
      color: #6c757d;
    }
    .messages, .alerts {
      padding: 1rem 1.5rem;
    }
    .message {
      padding: .75rem 1rem;
      border-radius: .5rem;
      margin-bottom: .75rem;
      font-size: .9rem;
    }
    .message.nurse {
      background: #e7f3ff;
      border-left: 4px solid var(--info);
    }
    .message.doctor {
      background: #d4edda;
      border-left: 4px solid var(--success);
    }
    .alerts li {
      padding: .5rem 0;
      font-size: .9rem;
      border-bottom: 1px solid #eee;
    }
    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform .3s ease;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      .hamburger {
        display: block !important;
      }
    }
    .hamburger {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1100;
      background: var(--primary);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: .5rem;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>

  <!-- Mobile Hamburger -->
  <button class="hamburger" onclick="document.querySelector('.sidebar').classList.toggle('open')">
    Menu
  </button>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>EMR System</h2>
      <p>Doctor Dashboard</p>
    </div>
    <nav class="sidebar-nav">
      <a href="#" class="active">Dashboard</a>
      {% if latest_visit %}
    <a href="{{ url_for('lab.lab_requests', patient_id=latest_visit.patient_id) }}">Lab Orders</a>
{% else %}
    <span>No lab orders available</span>
{% endif %}
      <a href="#">Prescriptions</a>
    </nav>

  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="dashboard-header">
      <h1>Welcome, Dr. {{ current_user.first_name if current_user.is_authenticated else '' }}</h1>
      <div class="profile">
        <span>{{ current_user.first_name }}</span>
      </div>
    </header>

    <!-- Stats -->
    <section class="stats">
      <div class="stat-card">
        Today’s Appointments
        <div>
          <h3>{{ today_appointments|length }}</h3>
          <p>Appointments</p>
        </div>
      </div>
      <div class="stat-card">
        Active Patients
        <div>
          <h3>{{ active_patients|length }}</h3>
          <p>Patients</p>
        </div>
      </div>
      <div class="stat-card">
        Pending Lab Results
        <div>
          <h3>{{ pending_lab_count }}</h3>
          <p>Results</p>
        </div>
      </div>
    </section>

    <!-- Grid -->
    <section class="dashboard-grid">
      <!-- Left Column -->
      <div class="grid-column">
        <div class="card">
          <h2>Patient Queue</h2>
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>HN</th>
                  <th>Age</th>
                  <th>Sex</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for patient in patients %}
                <tr id="patient-row-{{ patient.id }}">
                  <td><strong>{{ patient.full_name() }}</strong></td>
                  <td>{{ patient.hospital_number }}</td>
                  <td>{{ patient.age }}</td>
                  <td>{{ patient.sex.value }}</td>
                  <td><span class="status waiting">Waiting</span></td>
                  <td>
                    <a href="{{ url_for('doctor.clerk_patient', patient_id=patient.id) }}" class="btn btn-primary btn-sm small">Clerk</a>
                    <button type="button" class="btn btn-success btn-sm small done" onclick="markDone({{ patient.id }})">
                      Done
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>Recent Encounters</h2>
          <ul class="encounter-list">
            {% for note in recent_notes %}
              <li>
                <strong>{{ note.patient.full_name() }}</strong> — 
                {{ note.diagnosis or "No diagnosis yet" }} <br>
                <small>{{ note.created_at.strftime("%d %b %Y, %H:%M") }}</small>
              </li>
            {% else %}
              <li class="text-muted">No recent encounters.</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Right Column -->
      <div class="grid-column">
        <div class="card">
          <h2>Communication Center</h2>
          <div class="messages">
            <div class="message nurse">
              <strong>Nurse Aisha:</strong> Vitals recorded for John Doe.
            </div>
            <div class="message doctor">
              <strong>You:</strong> Please send to lab for CBC.
            </div>
            <a href="{{ url_for('doctor.send_message') }}" class="btn btn-primary mt-3">
              Send Message to Nurse
            </a>
          </div>

{% if unread_summary %}
<div class="alert alert-info mt-3">
    <strong>You have new message(s)</strong><br>

    {% for sender_id, msgs in unread_summary.items() %}
        {% set patient_id = sender_id.replace('patient-', '') %}
        <div class="mt-2 p-2 border rounded bg-light d-flex justify-content-between align-items-center">
            <div>
                <strong>Patient ID:</strong> {{ patient_id }} <br>
                <small>{{ msgs|length }} unread message(s)</small>
            </div>
            <div>
                <!-- View Message -->
                <a href="{{ url_for('doctor.chat_with_patient', patient_id=patient_id) }}"
                   class="btn btn-sm btn-success">
                    View Message
                </a>

                <!-- End Chat -->
                <form action="{{ url_for('doctor.end_chat', patient_id=patient_id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger">
                        End Chat
                    </button>
                </form>
            </div>
        </div>
    {% endfor %}
</div>
{% endif %}

        </div>

        <div class="card">
          <h2>Alerts & Notifications</h2>
          <ul class="alerts">
            <li>Low stock: Paracetamol (8 units left)</li>
            <li>Lab result ready: Jane Smith (Malaria)</li>
            <li>Patient overdue: Aisha Bello (Follow-up)</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function markDone(patientId) {
      if (!confirm("Mark this patient as done?")) return;

      try {
        const response = await fetch(`/doctor/mark_done/${patientId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        const data = await response.json();
        if (data.success) {
          const row = document.getElementById(`patient-row-${patientId}`);
          row.style.transition = "opacity 0.5s ease";
          row.style.opacity = 0;
          setTimeout(() => row.remove(), 500);
        } else {
          alert("Failed to mark as done.");
        }
      } catch (error) {
        console.error(error);
        alert("Network error.");
      }
    }


    //patient - doctor chat//

    const patientId = {{ patient.id if patient else 'null' }};

function loadMessages(patientId) {
    fetch(`/doctor/messages/${patientId}`)
        .then(res => res.json())
        .then(data => {
            let chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = "";
            data.messages.forEach(msg => {
                let bubble = document.createElement("div");
                bubble.className = "mb-2 p-2 rounded " + (msg.sender === "doctor" ? "bg-primary text-white ms-auto" : "bg-light");
                bubble.style.maxWidth = "70%";
                bubble.innerHTML = `${msg.content}<br><small>${msg.timestamp}</small>`;
                chatBox.appendChild(bubble);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });
}

// Auto-refresh
setInterval(() => loadMessages(PATIENT_ID_HERE), 2000);
loadMessages(PATIENT_ID_HERE);
// Poll messages every 2 seconds
setInterval(loadMessages, 2000);
loadMessages();

document.getElementById("sendMessageForm").addEventListener("submit", e => {
    e.preventDefault();
    const message = document.getElementById("messageInput").value;
    if (!message) return;
    fetch(`/doctor/send-message/${patientId}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message})
    }).then(res => res.json())
      .then(data => {
          document.getElementById("messageInput").value = "";
          loadMessages();
      });
});

// Notifications
function updateNotifications() {
    fetch("{{ url_for('doctor.doctor_notifications') }}")
        .then(res => res.json())
        .then(data => {
            document.getElementById("notifBadge").innerText = data.count;
        });
}

// Call every 2–3 seconds
setInterval(updateNotifications, 3000);
updateNotifications();


document.getElementById("sendMessageForm").addEventListener("submit", function(e) {
    e.preventDefault();
    let msg = document.getElementById("messageInput").value;
    fetch(`/doctor/send-message/${PATIENT_ID_HERE}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: msg})
    }).then(res => {
        document.getElementById("messageInput").value = "";
        loadMessages(PATIENT_ID_HERE);
    });
});

  </script>
</body>
</html>