{% extends "base.html" %}
{% block title %}Clerking – {{ patient.full_name() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row g-4">
    <!-- Main Clerking Area -->
    <main class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            Clerking for <strong>{{ patient.full_name() }}</strong>
          </h4>
          <div class="text-light">
            <strong>HN:</strong> {{ patient.hospital_number }}
          </div>
        </div>

        <div class="card-body">
          <!-- Action Buttons -->
          <div class="d-flex flex-wrap gap-2 mb-4">
            <a href="{{ url_for('patients.patient_summary', patient_id=patient.id) }}" 
               class="btn btn-outline-secondary btn-sm">
              View Full Details
            </a>
            <button type="button" class="btn btn-info btn-sm" id="investigationBtn">
              Request Investigation
            </button>
            <button type="button" class="btn btn-warning btn-sm" id="referBtn">
              Refer Patient
            </button>
            <button type="button" class="btn btn-success btn-sm" id="admitBtn">
              Admit Patient
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="outpatientBtn">
              Outpatient
            </button>
          </div>

          <!-- Clerking Form -->
          <form method="POST" novalidate>

            {% macro textarea_field(name, label, rows=3) %}
              <div class="mb-3">
                <label for="{{ name }}" class="form-label fw-medium">{{ label }}</label>
                <textarea 
                  class="form-control" 
                  id="{{ name }}" 
                  name="{{ name }}" 
                  rows="{{ rows }}"
                  placeholder="Enter {{ label.lower() }}..."
                >{{ getattr(history, name, '') if history else '' }}</textarea>
              </div>
            {% endmacro %}

            {{ textarea_field('presenting_complaint', 'Presenting Complaint', 2) }}
            {{ textarea_field('history_of_presenting_complaint', 'History of Presenting Complaint', 4) }}
            {{ textarea_field('past_medical_history', 'Past Medical History') }}
            {{ textarea_field('drug_history', 'Drug History') }}
            {{ textarea_field('family_history', 'Family History') }}
            {{ textarea_field('social_history', 'Social History') }}
            {{ textarea_field('examination_findings', 'Examination Findings', 4) }}
            {{ textarea_field('provisional_diagnosis', 'Provisional Diagnosis', 2) }}
            {{ textarea_field('plan', 'Management Plan') }}

            <div class="d-flex justify-content-end mt-4">
              <button type="submit" class="btn btn-primary">
                Save Clerking
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>

    <!-- Sidebar: Patient Summary -->
    <aside class="col-lg-4">
      <div class="card shadow-sm sticky-top" style="top: 1rem;">
        <div class="card-header bg-light">
          <h5 class="mb-0">Patient Summary</h5>
        </div>
        <div class="card-body">
          {% include "patients/summary_partial.html" %}
        </div>
      </div>
    </aside>
  </div>
</div>

{# ====================== PRESCRIPTION MODAL ====================== #}
<div class="modal fade" id="prescriptionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Prescription Form</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="prescriptionForm" method="POST">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Medication Name</label>
              <input type="text" name="medication_name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Dosage</label>
              <input type="text" name="dosage" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Frequency</label>
              <input type="text" name="frequency" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Duration</label>
              <input type="text" name="duration" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Notes (Optional)</label>
              <textarea name="notes" class="form-control" rows="2" placeholder="e.g., Take with food"></textarea>
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Prescription</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# ====================== REFERRAL MODAL ====================== #}
<div class="modal fade" id="referralModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Refer Patient</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="referralForm">
          <div class="mb-3">
            <label class="form-label">Referral Type</label>
            <select name="referral_type" class="form-select">
              <option value="Internal Specialist">Internal Specialist</option>
              <option value="External Hospital">External Hospital</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Reason for Referral</label>
            <textarea name="reason" class="form-control" rows="3" required></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Receiving Facility / Specialist</label>
            <input type="text" name="referred_to" class="form-control" 
                   placeholder="e.g., Cardiology Department or St. Luke’s Hospital">
          </div>
          <div class="mb-3">
            <label class="form-label">Additional Notes</label>
            <textarea name="notes" class="form-control" rows="2"></textarea>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Send Referral</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Bootstrap Modals
  const prescriptionModal = new bootstrap.Modal(document.getElementById('prescriptionModal'));
  const referralModal = new bootstrap.Modal(document.getElementById('referralModal'));

  // Prescription Modal (Admit / Outpatient)
  document.getElementById('admitBtn').addEventListener('click', () => openPrescriptionModal('Admit'));
  document.getElementById('outpatientBtn').addEventListener('click', () => openPrescriptionModal('Outpatient'));

  function openPrescriptionModal(type) {
    document.getElementById('modalTitle').textContent = `${type} Prescription`;
    document.getElementById('prescriptionForm').action = `/doctor/prescribe/{{ patient.id }}/${type.toLowerCase()}`;
    prescriptionModal.show();
  }

  // Referral Modal
  document.getElementById('referBtn').addEventListener('click', () => referralModal.show());

  // Investigation Button
  document.getElementById('investigationBtn').addEventListener('click', () => {
    window.location.href = "{{ url_for('doctor.request_investigation', patient_id=patient.id) }}";
  });
</script>
{% endblock %}